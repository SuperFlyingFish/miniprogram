var t=require("../../api.js"),e=getApp(),a={init:function(a,o){var s=this;s.page=a,e=o,s.page.orderPay=function(a){function o(t,a,o){e.request({url:a,data:{order_id:t,pay_type:"WECHAT_PAY"},complete:function(){wx.hideLoading()},success:function(t){0==t.code&&wx.requestPayment({timeStamp:t.data.timeStamp,nonceStr:t.data.nonceStr,package:t.data.package,signType:t.data.signType,paySign:t.data.paySign,success:function(t){console.log("success"),console.log(t)},fail:function(t){console.log("fail"),console.log(t)},complete:function(t){"requestPayment:fail"!=t.errMsg&&"requestPayment:fail cancel"!=t.errMsg?wx.redirectTo({url:"/"+o+"?status=1"}):wx.showModal({title:"提示",content:"订单尚未支付",showCancel:!1,confirmText:"确认",success:function(t){t.confirm&&wx.redirectTo({url:"/"+o+"?status=0"})}})}}),1==t.code&&wx.showToast({title:t.msg,image:"/images/icon-warning.png"})}})}function i(t,a,o){var s=wx.getStorageSync("user_info");wx.showModal({title:"当前账户余额："+s.money,content:"是否使用余额",success:function(s){s.confirm&&(wx.showLoading({title:"正在提交",mask:!0}),e.request({url:a,data:{order_id:t,pay_type:"BALANCE_PAY"},complete:function(){wx.hideLoading()},success:function(t){0==t.code&&wx.redirectTo({url:"/"+o+"?status=1"}),1==t.code&&wx.showModal({title:"提示",content:t.msg,showCancel:!1})}}))}})}var r=a.currentTarget.dataset.index,n=s.page.data.order_list[r],c=new Array;if(void 0!==s.page.data.pay_type_list)c=s.page.data.pay_type_list;else if(void 0!==n.pay_type_list)c=n.pay_type_list;else if(void 0!==n.goods_list[0].pay_type_list)c=n.goods_list[0].pay_type_list;else{var d={};d.payment=0,c.push(d)}var g=getCurrentPages(),u=g[g.length-1].route,l=t.order.pay_data;-1!=u.indexOf("pt")?l=t.group.pay_data:-1!=u.indexOf("miaosha")&&(l=t.miaosha.pay_data),1==c.length?(wx.showLoading({title:"正在提交",mask:!0}),0==c[0].payment&&o(n.order_id,l,u),3==c[0].payment&&i(n.order_id,l,u)):wx.showModal({title:"提示",content:"选择支付方式",cancelText:"余额支付",confirmText:"微信支付",success:function(t){t.confirm?(wx.showLoading({title:"正在提交",mask:!0}),o(n.order_id,l,u)):t.cancel&&i(n.order_id,l,u)}})},s.page.order_submit=function(o,i){function r(){wx.showLoading({title:"正在提交",mask:!0}),e.request({url:n,method:"post",data:o,success:function(t){if(0==t.code){var r=function(){e.request({url:c,data:{order_id:n,order_id_list:g,pay_type:u,form_id:o.formId},success:function(t){0==t.code?(setTimeout(function(){wx.hideLoading()},1e3),"pt"==i?"ONLY_BUY"==s.page.data.type?wx.redirectTo({url:d+"?status=2"}):wx.redirectTo({url:"/pages/pt/group/details?oid="+n}):void 0!==s.page.data.goods_card_list&&s.page.data.goods_card_list.length>0?s.page.setData({show_card:!0}):wx.redirectTo({url:d+"?status=-1"})):s.page.showToast({title:t.msg,image:"/images/icon-warning.png"})}})};setTimeout(function(){s.page.setData({options:{}})},1);var n=t.data.order_id||"",g=t.data.order_id_list?JSON.stringify(t.data.order_id_list):"",u="";0==o.payment?e.request({url:c,data:{order_id:n,order_id_list:g,pay_type:"WECHAT_PAY"},success:function(t){if(0!=t.code)1!=t.code||s.page.showToast({title:t.msg,image:"/images/icon-warning.png"});else{setTimeout(function(){wx.hideLoading()},1e3),wx.requestPayment({timeStamp:t.data.timeStamp,nonceStr:t.data.nonceStr,package:t.data.package,signType:t.data.signType,paySign:t.data.paySign,success:function(t){"pt"==i?"ONLY_BUY"==s.page.data.type?wx.redirectTo({url:d+"?status=2"}):wx.redirectTo({url:"/pages/pt/group/details?oid="+n}):wx.redirectTo({url:d+"?status=1"})},fail:function(t){},complete:function(t){"requestPayment:fail"!=t.errMsg&&"requestPayment:fail cancel"!=t.errMsg?"requestPayment:ok"!=t.errMsg?wx.redirectTo({url:d+"?status=-1"}):void 0!==s.page.data.goods_card_list&&s.page.data.goods_card_list.length>0?s.page.setData({show_card:!0}):wx.redirectTo({url:d+"?status=-1"}):wx.showModal({title:"提示",content:"订单尚未支付",showCancel:!1,confirmText:"确认",success:function(t){t.confirm&&wx.redirectTo({url:d+"?status=0"})}})}});var e=wx.getStorageSync("quick_list");if(e){for(var o=e.length,r=0;r<o;r++)for(var c=e[r].goods,g=c.length,u=0;u<g;u++)c[u].num=0;wx.setStorageSync("quick_lists",e);for(var l=wx.getStorageSync("carGoods"),o=l.length,r=0;r<o;r++)l[r].num=0,l[r].goods_price=0,a.setData({carGoods:l});wx.setStorageSync("carGoods",l);var p=wx.getStorageSync("total");p&&(p.total_num=0,p.total_price=0,wx.setStorageSync("total",p));wx.getStorageSync("check_num");0,wx.setStorageSync("check_num",0);for(var _=wx.getStorageSync("quick_hot_goods_lists"),o=_.length,r=0;r<o;r++)_[r].num=0,a.setData({quick_hot_goods_lists:_});wx.setStorageSync("quick_hot_goods_lists",_)}}}}):2==o.payment?(u="HUODAO_PAY",r()):3==o.payment&&(u="BALANCE_PAY",r())}if(1==t.code)return wx.hideLoading(),void s.page.showToast({title:t.msg,image:"/images/icon-warning.png"})}})}var n=t.order.submit,c=t.order.pay_data,d="/pages/order/order";if("pt"==i?(n=t.group.submit,c=t.group.pay_data,d="/pages/pt/order/order"):"ms"==i&&(n=t.miaosha.submit,c=t.miaosha.pay_data,d="/pages/miaosha/order/order"),3==o.payment){var g=wx.getStorageSync("user_info");wx.showModal({title:"当前账户余额："+g.money,content:"是否确定使用余额支付",success:function(t){t.confirm&&r()}})}else r()}}};module.exports=a; 
 			